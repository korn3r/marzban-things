eu_node - сервер с панелью Marzban и инбаундом xHTTP.  
ru_node - промежуточный сервер с haproxy и nginx (ради красивой странички с ошибкой и получения серта через сертбота). Хапрокси пересылает http трафик на вышестоящий eu_node. На ru_node при этом нет инстанса xray. Именно хапрокси потому что общаться с бэкендом он умеет по HTTP2



Обозначения в конфигах (то что нужно поменять на своё):  
{ПУТЬ-ПОДПИСКИ} - путь подписки указанный в .env панели.  
{ПУТЬ-ПАНЕЛИ} - длинный путь, за которым находится панель на eu_node  
{ПУТЬ-ВПНА} - путь за которым спрятан редирект на xHTTP инбаунд на нгинксе на eu_node  
{DOMAIN1.COM} - домен панели (eu_node)  
{DOMAIN2.COM} - домен ru_node  
{DB-USER},{DB-PASSWORD} и {DB-NAME} - соответственно имя, пароль и название базы данных марзбана в MariaDB  

Получить сертификат через нгинкс можно вот так (контейнер нгинкса должен быть запущен!).  
Рекомендуется запускать сначала с "--dry-run", так производитеся тест процесса выпуска сертификата без собственно выпуска. В режиме "--dry-run" сильно выше лимиты (в случае множественных неудачных попыток выпуска без dry-run сервер letsencrypt может заблокировать попытки на некоторое время). 
```
docker compose run --rm certbot certonly --webroot --webroot-path /var/www/certbot/ -d {DOMAIN2.COM}
```

  
Настройка инбаунда БЕЗ промежуточной ноды:  
Alpn можно оставить так (h3, h2), или сделать два отдельных инбаунда для http2 или http3

<img src="https://raw.githubusercontent.com/korn3r/marzban-things/refs/heads/main/_xHTTP/eu_node/inbound-settings.png" width=30% height=30%>  

  

Если промежуточная нода нужна, то в настройках панели нужно вписать вместо домена панели домен промежуточного сервера (и в .env в префикс подписки)  

Дополнительно в конфиге нгинкса надо изменить мапинг, чтобы правильно формировалась ссылка на профиль в клиенте - тоже указать домен промежуточного сервера вместо домена самой панели ({DOMAIN2.COM} вместо {DOMAIN1.COM} в следующем блоке). 
  
```
    map $upstream_http_profile_web_page_url $new_header {
            "" "";
            "~^http://localhost/(.*)$" "https://{DOMAIN1.COM}/$1";
            "~^http://{DOMAIN1.COM}/(.*)$" "https://{DOMAIN1.COM}/$1";
    }
```
